var map;var vector;var switcherDlg;var editLayer=null;var mapOptions=null;var specifyLayers=null;var allLayerOptions={};var googleOptionsKey="T_google";var aMapOptionsKey="T_amap";var DEFAULT_TOOLCODE="T0";var initedMap=false;var gmap1;var gmap2;var gmap3;var style_mark;var style_cell;var style_cellr;var style_line;var style_line2;var styleMap;var linkLineVisibily=false;var drawLayer;var drawControls;var boxes;var popup;var currGoogleMap=null;var currentAMap=null;var graticule;var showGGlMap=true;var showAMap=true;var mapMinZoom=0;function initLayerEditor(){editLayer=new EditLayer("layersortable");editLayer.sortable();var a=getLayerSwitcherControl();map.addControl(a)}function updateLayer(a){var b=$(a);b.button("busy");editLayer.updateBtn=b;editLayer.updateLayer()}$(document).ready(function(){initMap();
mapOptions={maxBounds:new OpenLayers.Bounds(70,5,150,60)};$("#switchDlg").css("overflow","scroll");switcherDlg=new Dialog("switchDlg",{title:"图层控制",width:540,height:360,buttons:{ok:{value:"关闭",iconCls:"icon-cancel",click:function(){switcherDlg.hide()}}}})});function EditLayer(a){this.id=a;this.updateBtn;this.toolCode=getToolCode(window);this.createdOverlayLayer=false;this.layers={};this.overlayLayer;this.minZoom=mapMinZoom;this.events={}}EditLayer.prototype={sortable:function(){var a=this;this.refresh();$("#"+this.id).sortable({distance:10,items:"li:not(.ui-state-disabled)",placeholder:"ui-state-highlight",update:function(b,c){a.updateLayerOrder(b,c)}})},refresh:function(){this.getLayers()},getLayers:function(){var b=this.id;var a=this;$.post(_appContext+"/gis/layerCtrl.do?action=queryLayers&toolCode="+this.toolCode,function(s){if(!s){return
}if(a.overlayLayer){try{map.removeLayer(a.overlayLayer)}catch(o){info(o)}}var l=$("#"+b);var t=10;var m=specifyLayers&&specifyLayers.join();for(var h=0;h<=s.length-1;h++){var n=s[h];if(m&&!(m.indexOf(n.layerName)!=-1||n.baseLayer==1||n.layerName=="cell"||n.layerName=="google")){delete s[h];continue}if(allLayerOptions[n.toolCode+"_"+n.layerName]){allLayerOptions[n.toolCode+"_"+n.layerName].layerOrder=n.layerOrder;allLayerOptions[n.toolCode+"_"+n.layerName].layerNameCN=n.layerNameCN;allLayerOptions[n.toolCode+"_"+n.layerName].left=n.left;allLayerOptions[n.toolCode+"_"+n.layerName].right=n.right;allLayerOptions[n.toolCode+"_"+n.layerName].bottom=n.bottom;allLayerOptions[n.toolCode+"_"+n.layerName].top=n.top}else{allLayerOptions[n.toolCode+"_"+n.layerName]=n}if(!allLayerOptions[n.toolCode+"_"+n.layerName].layerId){if(n.layerName.indexOf("google")!=-1){allLayerOptions[n.toolCode+"_"+n.layerName].toolCode="T";
if(showGGlMap&&currGoogleMap==null){gmap1=new OpenLayers.Layer.Google("Google Map",{sphericalMercator:false,visibility:n.visibility});map.addLayer(gmap1);currGoogleMap=gmap1;allLayerOptions[n.toolCode+"_"+n.layerName].layerId=currGoogleMap.id}}else{if(n.layerName=="amap"&&!currentAMap){currentAMap=new OpenLayers.Layer.AMap("AMap",{sphericalMercator:false});map.addLayer(currentAMap);allLayerOptions[n.toolCode+"_"+n.layerName].layerId=currentAMap.id}else{}}}else{if(allLayerOptions[n.toolCode+"_"+n.layerName].layerId&&!allLayerOptions[n.toolCode+"_"+n.layerName].visibility){a.delLayerOnMap(n.toolCode+"_"+n.layerName)}else{if(allLayerOptions[n.toolCode+"_"+n.layerName].layerId){var f=map.getLayer(allLayerOptions[n.toolCode+"_"+n.layerName].layerId);if(f){f.times=n.times}a.showLayer(n.layerName,n.toolCode)
}}}}var d=map.layers;d=map.layers;l.empty();var g=0;for(var r in allLayerOptions){var n=allLayerOptions[r];if(n.layerName.indexOf("google")==-1&&n.layerName!="amap"){g++;var q=$("<li class=\"ui-state-default\" style='overflow:hidden;'></li>").prependTo(l);q.append('<span style="width:30px;margin-left:10px;">'+(g)+'</span><span style="margin-left:14px;"><input type="checkbox" layerCode="'+r+'"'+(n.visibility?"checked='true'":"")+' id="'+r+'"/></span>');q.append('<span  style="white-space: nowrap;text-overflow: ellipsis;overflow: hidden;*table-layout: fixed;width:300px;" title="'+n.layerNameCN+'"><label for="'+r+'">'+n.layerNameCN+"</label></span>");if(n.layerName.indexOf("OpenLayers.Layer.Vector")==-1){q.append('<span><a href="#" layerId="'+n.layerId+'" layerCode="'+r+'" height="16" width="16" '+(n.allowDelete?'class="del"':"")+">&nbsp;&nbsp;</a></span>")
}$(":checkbox",q).checkbox().bind("change",{self_:a},a.toggleLayer)}}l.find("a.del").bind("click",function(){var e=$(this).attr("layerCode");askFunc('确定删除<span style="color:#ff1111">'+allLayerOptions[e].layerNameCN+"</span>图层?",function(){a.deleteLayer(e)});return false});if(currGoogleMap){var r=googleOptionsKey;var n=currGoogleMap;var q=$('<li class="ui-state-default ui-state-disabled"></li>').appendTo(l);q.append('<span style="width:30px;margin-left:10px;">'+(++g)+'</span><span style="margin-left:14px;"><input type="checkbox"  layerCode="'+r+'" '+(n.visibility?"checked='true'":"")+' id="'+r+'"/></span>');q.append('<span><label for="'+n.id+'">'+n.name+"</label></span>");allLayerOptions[r].layerId=currGoogleMap.id;$(":checkbox",q).checkbox().bind("change",{self_:a},a.toggleLayer)}else{if(currentAMap){var r=aMapOptionsKey;
var n=currentAMap;var q=$('<li class="ui-state-default ui-state-disabled"></li>').appendTo(l);q.append('<span style="width:30px;margin-left:10px;">'+(++g)+'</span><span style="margin-left:14px;"><input type="checkbox"  layerCode="'+r+'" '+(n.visibility?"checked='true'":"")+' id="'+r+'"/></span>');q.append('<span><label for="'+n.id+'">'+n.name+"</label></span>");allLayerOptions[r].layerId=currentAMap.id;$(":checkbox",q).checkbox().bind("change",{self_:a},a.toggleLayer)}else{}}d=map.layers;for(var h=0;h<d.length;h++){var p=d[h];if(p.id&&p.id.indexOf("OpenLayers.Layer.Vector")!=-1){map.raiseLayer(p,d.length)}}a.createOverlayLayer();zoomToExtent();var j=map.getZoom();if(j<7){map.zoomTo(7)}if(!initedMap){initMapAfter();toggleToolbar();initedMap=true}var c=map.viewPortDiv;info(c)})},createOverlayLayer:function(){this.layers=[];
var d=1;for(var b in allLayerOptions){var a=allLayerOptions[b];if(a.visibility){this.layers[this.layers.length]={layerName:a.layerName,toolCode:a.toolCode};if(a.times&&a.times>d){d=a.times}}}var c=new OpenLayers.Layer.Overlay(this.layers,_appContext+"/gis/index.do?action=index",{visibility:true,maxExtent:mapOptions.maxBounds,toolCode:"T0",times:d,sphericalMercator:false,buffer:1,minZoom:this.minZoom,isBaseLayer:true});map.addLayer(c);map.setLayerIndex(c,0);this.overlayLayer=c},setMinZoom:function(a){this.minZoom=a;this.overlayLayer.minZoom=a},toggleLayer:function(b){var g=b.data.self_;var f=$(this);var h=$(this).attr("id");if(h.indexOf("google")!=-1){var d=currGoogleMap;if($(this).prop("checked")){if(showGGlMap){if(!currGoogleMap){gmap1=new OpenLayers.Layer.Google("Google Map",{sphericalMercator:false,visibility:true});
map.addLayer(gmap1);currGoogleMap=gmap1}else{d.setVisibility(true)}allLayerOptions[h].layerId=currGoogleMap.id;allLayerOptions[h].visibility=true;if(layerSwitcherControl){layerSwitcherControl.redraw()}}}else{d.setVisibility(false);allLayerOptions[googleOptionsKey].visibility=false;var c=$("#"+h+" :checkbox");var e=map.getLayer($(c[c.length-2]).attr("id"));if(map.layers.length==1){var a=allLayerOptions[h].layerId;if(a&&map.getLayer(a)!=null){map.getLayer(h).setVisibility(false)}}else{g.delLayerOnMap(h,false)}}}else{if(h.indexOf("amap")!=-1){var d=currentAMap;if($(this).prop("checked")){if(!currentAMap){currentAMap=new OpenLayers.Layer.AMap("AMap",{sphericalMercator:false});map.addLayer(currentAMap)}else{d.setVisibility(true)}allLayerOptions[h].layerId=currentAMap.id;allLayerOptions[h].visibility=true;
if(layerSwitcherControl){layerSwitcherControl.redraw()}}else{d.setVisibility(false);allLayerOptions[aMapOptionsKey].visibility=false;var c=$("#"+h+" :checkbox");var e=map.getLayer($(c[c.length-2]).attr("id"));g.delLayerOnMap(h,false)}}else{if($(this).prop("checked")){allLayerOptions[h].visibility=1;var a=allLayerOptions[h].layerId;if(!a||map.getLayer(a)==null){}else{allLayerOptions[h].visibility=1}}else{allLayerOptions[h].visibility=0;if(map.layers.length==1){var a=allLayerOptions[h].layerId}else{}}g.refreshMapLayers()}}g.onListener("addLayer")},delLayerOnMap:function(b,c){if(!allLayerOptions[b]){return}var a=allLayerOptions[b].layerId;if(allLayerOptions[b]){allLayerOptions[b].visibility=0;delete allLayerOptions[b].layerId;if(c||(typeof c=="undefined")){$('a.del[layerCode="'+b+'"]').closest("li").remove();
delete allLayerOptions[b]}if(layerSwitcherControl){layerSwitcherControl.redraw()}}},createLayer:function(c){var b=allLayerOptions[c];var a=b.layerName,d=b.layerNameCN;b.visibility=true;lon=(b.right+b.left)/2,lat=(b.top+b.bottom)/2,allLayerOptions[c].layerId=c;return allLayerOptions[c]},addLayer:function(b,e,m,j,c,a){c=this.getLayerToolCode(b,c);var n=this.getLayerByNameCode(b,c);if(!n||!n.visibility){var l=c+"_"+b;allLayerOptions[l]={};allLayerOptions[l].layerId=l;allLayerOptions[l].visibility=m;allLayerOptions[l].layerName=b;allLayerOptions[l].layerOrder=a.layerOrder||1;allLayerOptions[l].layerNameCN=e;allLayerOptions[l].allowDelete=true;if(a){allLayerOptions[l].left=a.left?a.left:0;allLayerOptions[l].right=a.right?a.right:0;allLayerOptions[l].bottom=a.bottom?a.bottom:0;allLayerOptions[l].top=a.top?a.top:0
}var g=allLayerOptions[l];var f=$("#"+this.id);var d=f.find("li").length-1;var h=$('<li class="ui-state-default"></li>').appendTo(f);h.append('<span style="width:30px;margin-left:10px;">'+(d)+'</span><span style="margin-left:14px;"><input type="checkbox" layerCode="'+l+'"'+(g.visibility?"checked='true'":"")+' id="'+l+'"/></span>');h.append('<span  style="white-space: nowrap;text-overflow: ellipsis;overflow: hidden;*table-layout: fixed;width:300px;" title="'+g.layerNameCN+'"><label for="'+l+'">'+g.layerNameCN+"</label></span>");if(g.layerName.indexOf("OpenLayers.Layer.Vector")==-1){h.append('<span><a href="#" layerId="'+g.layerId+'" layerCode="'+l+'" height="16" width="16" '+(g.allowDelete?'class="del"':"")+">&nbsp;&nbsp;</a></span>")}var i=this;$(":checkbox",h).checkbox().bind("change",{self_:i},i.toggleLayer);
h.find("a.del").bind("click",function(){var k=$(this).attr("layerCode");askFunc('确定删除<span style="color:#ff1111">'+allLayerOptions[k].layerNameCN+"</span>图层?",function(){i.deleteLayer(k)});return false});if(layerSwitcherControl){layerSwitcherControl.redraw()}}this.onListener("addLayer")},getMapLayers:function(){var c=map.layers;for(var b=c.length-1;b>=0;b--){this.layers[c[b].id]=c[b];if(c[b].layername){var d={};var a=map.getCenter();d.centerLon=a.lon;d.centerLat=a.lat;d.layerName=c[b].layername;allLayerOptions[c[b].layername]=d}}},updateLayer:function(){var m={};m.layerInfoCount=1;var c=1;var k=this;var d=$("#"+this.id+" :checkbox");var c=0;var a=[];for(var f=d.length-1;f>=0;f--){var n=d[f];var l=n.id;allLayerOptions[l].layerOrder=c;a[c]=allLayerOptions[l];c++}this.refreshMapLayers();var g=0;
for(var l in allLayerOptions){var e=allLayerOptions[l];var h="layers["+g+"].layerOrder";m[h]=e.layerOrder?e.layerOrder:g;h="layers["+g+"].layerName";m[h]=e.layerName;h="layers["+g+"].toolCode";m[h]=e.toolCode;h="layers["+g+"].visibility";var b=e.visibility?1:0;m[h]=b;g++}m.layerInfoCount=g;$.post(_appContext+"/gis/updateLayer.do?action=updateLayerOrder",m,function(i){k.updateBtn.button("free")})},refreshMapLayers:function(){var g=0;var c=[];var e=0;for(var d in allLayerOptions){if(allLayerOptions[d].visibility){c[e]=allLayerOptions[d];e++}}c.sort(this.sortLayers);var a=[];for(var b=0;b<c.length;b++){var f=c[b];if(f.visibility){a[a.length]={layerName:f.layerName,toolCode:f.toolCode}}}if(this.overlayLayer){this.overlayLayer.setLayers(a)}},sortLayers:function(d,c){var b=d.layerOrder;var a=c.layerOrder;
if(b>a){return 1}else{if(b<a){return -1}}return 0},deleteLayer:function(e){var b=$('a.del[layerCode="'+e+'"]');var d=this;var c={layerName:allLayerOptions[e].layerName,toolCode:allLayerOptions[e].toolCode};var a=$('<div class="progress" style="width:220">正在删除图层:'+allLayerOptions[e].layerNameCN+"</div>").appendTo(document.body).prompt();$.post(_appContext+"/gis/updateLayer.do?action=deleteLayer",c,function(g){b.closest("li").remove();var f=allLayerOptions[e].layerId;a.hide();delete allLayerOptions[e];d.refreshMapLayers()});this.onListener("removeLayer")},delLayerByNameTool:function(a,c){c=this.getLayerToolCode(a,c);var b=c+"_"+a;this.delLayerOnMap(b,true);this.onListener("removeLayer")},updateLayerOrder:function(j,g){var c=$("#"+this.id+" :checkbox");var n=this;var m=g.item;var f=m.find(":checkbox:first").attr("layerCode");
var c=$("#"+this.id+" :checkbox");var a=0;for(var e=c.length-1;e>=0;e--){var m=c[e];var h=m.id;allLayerOptions[h].layerOrder=a;a++}for(var e=0;e<=c.length-1;e++){var b=$(c[e]).attr("id");if(f==b){if(allLayerOptions[b]){var d=allLayerOptions[b].layerId;var k=map.getLayer(d);if(k){map.setLayerIndex(k,allLayerOptions[b].layerOrder)}}}}var l=$("#"+this.id).find("li");$.each(l,function(o,i){$(i).find("span:eq(0)").html(o+1)});this.refreshMapLayers()},showLayer:function(a,d){d=this.getLayerToolCode(a,d);var c=d+"_"+a;if(allLayerOptions[c]){var b=this.getLayerByNameCode(a,d);if(b&&!b.visibility){$("#"+this.id+" li :checkbox[layerCode='"+c+"']").checkbox("check",true);allLayerOptions[c].visibility=true}else{allLayerOptions[c].visibility=true;$("#"+this.id+" li :checkbox[layerCode='"+c+"']").checkbox("check",true)
}}if(layerSwitcherControl){layerSwitcherControl.redraw()}this.onListener("addLayer")},hideLayer:function(a,c){c=this.getLayerToolCode(a,c);var b=c+"_"+a;if(allLayerOptions[b]&&allLayerOptions[b].visibility){allLayerOptions[b].visibility=false;$("#"+this.id+" li :checkbox[layerCode='"+b+"']").checkbox("check",false)}if(layerSwitcherControl){layerSwitcherControl.redraw()}this.onListener("addLayer")},getLayerByNameCode:function(a,c){c=this.getLayerToolCode(a,c);var b=c+"_"+a;if(allLayerOptions[b]&&allLayerOptions[b].layerId){return allLayerOptions[b]}},getLayerByName:function(b){var a=map.getLayersBy("layername",b);if(a.length>0){return a[0]}return null},getLayerToolCode:function(a,b){if(a.indexOf("google")!=-1){return"T"}else{if(!b){return"T0"}}return b},addEvents:function(b){if(typeof b!=undefined){for(var a in b){this.events[a]=b[a]
}}},onListener:function(a){if(this.events[a]){this.events[a].apply()}}};var uploadLayerDlg;function showUploadLayerDlg(){if(!uploadLayerDlg){var b=$(document).height();var a=$(document).width();if($(document).height()==0){b=parent.window.screenHeight;a=parent.window.width}$("#uploadLayerDlgIframe").css("height",b);if(b>400){b=400}uploadLayerDlg=new Dialog("uploadLayerDlg",{width:a-120,height:b})}if(uploadLayerDlg){uploadLayerDlg.show()}}$(document).ready(function(){if(!uploadLayerDlg){var b=$(document).height();var a=$(document).width();if($(document).height()==0){b=parent.window.screenHeight;a=parent.window.width}$("#uploadLayerDlgIframe").css("height",b);if(b>300){b=300}if(a>480){a=480}uploadLayerDlg=new Dialog("uploadLayerDlg",{width:a,height:b})}});function toggleToolbar(){$("#mapToolbar").find("img").hover(function(){if(!$(this).attr("choose")){this.src=this.src.replace(".png","-active.png")
}},function(){if(!$(this).attr("choose")){this.src=this.src.replace("-active.png",".png")}}).click(function(){var a=$("#mapToolbar").find('img[choose="1"]');if(a.length>0){a.get(0).src=a.get(0).src.replace("-active.png",".png");a.removeAttr("choose")}var b=$(this);b.attr("choose","1");if(this.src.indexOf("-active.png")==-1){this.src=this.src.replace(".png","-active.png")}})}function zoomToExtent(){var h=300,c=300,b=-300,f=-300;for(var j in allLayerOptions){var g=allLayerOptions[j];if(g.layerName.indexOf("google")==-1){if(g.visibility&&(g.left!=0||g.right!=0)){if(g.left!=0){var l=g.left;if(h>l){h=l}}if(g.bottom!=0){var k=g.bottom;if(c>k){c=k}}if(g.right!=0){var d=g.right;if(b<d){b=d}}if(g.top!=0){var i=g.top;if(f<i){f=i}}}}}if(h!=300&&h!=0&&b!=0){var a=new OpenLayers.Bounds(h,c,b,f);map.zoomToExtent(a,false);
var e=map.getZoom();if(e<7){map.zoomTo(7)}}}function getToolCode(a){if(typeof a=="undefined"){a=window}if(a.toolCode!=null){return a.toolCode}if(a.parent){if(a.parent==top){if(a.toolCode!=null){return a.toolCode}else{return"T0"}}return getToolCode(a.parent)}else{return"T0"}}function info(a){if(!(typeof console=="undefined")){console.log(a)}}var layerSwitcherControl;function getLayerSwitcherControl(){layerSwitcherControl=new OpenLayers.Control.LayerSwitcher({ascending:true});OpenLayers.Util.extend(layerSwitcherControl,{checkRedraw:function(){var e=false;if(!this.layerStates.length||(this.map.layers.length!=this.layerStates.length)){e=true}else{for(var c=0,a=this.layerStates.length;c<a;c++){var d=this.layerStates[c];var b=this.map.layers[c];if((d.name!=b.name)||(d.inRange!=b.inRange)||(d.id!=b.id)||(d.visibility!=b.visibility)){e=true;
break}}}return e},redraw:function(){if(!this.checkRedraw()){return this.div}this.clearLayersArray("base");this.clearLayersArray("data");var d=false;var l=false;var e=0;for(var m in allLayerOptions){var f=allLayerOptions[m];var g=false;if(g){l=true}else{d=true}var k=f.visibility;var h=document.createElement("input");h.id=this.id+"_input_"+m;h.name=(g)?this.id+"_baseLayers":m;h.type=(g)?"radio":"checkbox";h.value=m;h.checked=k;h.defaultChecked=k;var a={inputElem:h,layer:f,layerSwitcher:this};OpenLayers.Event.observe(h,"mouseup",OpenLayers.Function.bindAsEventListener(this.onInputClick,a));var b=document.createElement("span");OpenLayers.Element.addClass(b,"labelSpan");if(!g&&!f.inRange){b.style.color="gray"}b.innerHTML=f.layerNameCN;b.style.verticalAlign=(g)?"bottom":"baseline";OpenLayers.Event.observe(b,"click",OpenLayers.Function.bindAsEventListener(this.onInputClick,a));
var o=document.createElement("br");var n=(g)?this.baseLayers:this.dataLayers;n.push({layer:f,inputElem:h,labelSpan:b});var c=(g)?this.baseLayersDiv:this.dataLayersDiv;var j=$(c);j.prepend(o);j.prepend(b);j.prepend(h)}this.dataLbl.style.display=(d)?"":"none";this.baseLbl.style.display=(l)?"":"none";return this.div},onInputClick:function(d){if(!this.inputElem.disabled){this.inputElem.checked=!this.inputElem.checked;var c=this.inputElem.value;var b=allLayerOptions[c];if(b){var a=b.layerName;var f=b.toolCode;if(b){if(this.inputElem.checked){editLayer.showLayer(a,f)}else{editLayer.hideLayer(a,f)}}}}OpenLayers.Event.stop(d)},updateMap:function(){}});return layerSwitcherControl}OpenLayers.Layer.Overlay=OpenLayers.Class(OpenLayers.Layer.XYZ,{name:"OverlayMap",minZoom:0,layers:{},initialize:function(d,c,b){this.layers=d;
c=c||this.url;name=name||this.name;var a=[name,c,b];OpenLayers.Layer.XYZ.prototype.initialize.apply(this,a)},getURL:function(a){var e=this.map.getResolution();var d=e*this.tileSize.w;var c=e*this.tileSize.h;var h=Math.round((a.left-this.maxExtent.left)/(e*this.tileSize.w));var g=Math.round((a.bottom-this.maxExtent.bottom)/(e*this.tileSize.h));var f=this.map.getZoom()+this.minZoom;var j=this.maxExtent;var b=this.url+"&z="+f+"&x="+h+"&y="+g+"&times="+this.times+"&toolCode="+this.toolCode;for(var i in this.layers){if(this.layers[i].layerName.indexOf("google")==-1&&this.layers[i].layerName!="amap"){b+="&layers="+this.layers[i].layerName+"&toolCodes="+this.layers[i].toolCode}}return b},addLayer:function(b,a){this.refreshLayer()},removeLayer:function(a){this.refreshLayer()},setLayers:function(a){this.layers=a;
this.times++;this.refreshLayer()},refreshLayer:function(){var d=this.grid;var f=d.length;if(f>0){var c=Math.round(f/2);for(var e=c;e>=0;e--){var a=d[e];for(var b=0;b<a.length;b++){if(a[b].imgDiv){a[b].imgDiv.src=this.getURL(a[b].bounds)}}}for(var e=c-1;e<f&&e>0;e++){var a=d[e];for(var b=0;b<a.length;b++){if(a[b].imgDiv){a[b].imgDiv.src=this.getURL(a[b].bounds)}}}}},CLASS_NAME:"OpenLayers.Layer.Overlay"});function changeMap(b,a){if(currGoogleMap==null&&currentAMap==null){return}if(selectedDiv!=b){$(b).addClass("typeSelected");if(selectedDiv){$(selectedDiv).removeClass("typeSelected")}selectedDiv=b}if(a==1&&gmap1!=currGoogleMap){map.removeLayer(currGoogleMap,true);map.addLayer(gmap1);currGoogleMap=gmap1}if(a==2&&gmap2!=currGoogleMap){if(gmap2==null){gmap2=new OpenLayers.Layer.Google("Google Map",{sphericalMercator:false,type:google.maps.MapTypeId.HYBRID,numZoomLevels:20})
}map.addLayer(gmap2);map.removeLayer(currGoogleMap,true);currGoogleMap=gmap2}if(a==3&&gmap3!=currGoogleMap){if(gmap3==null){gmap3=new OpenLayers.Layer.Google("Google Map",{sphericalMercator:false,type:google.maps.MapTypeId.TERRAIN,numZoomLevels:20})}map.addLayer(gmap3);map.removeLayer(currGoogleMap,true);currGoogleMap=gmap3}if(a==1&&currentAMap){currentAMap.hideSatelliteLayer()}if(a==2&&currentAMap){currentAMap.showSatelliteLayer()}}function addControl(a,b){drawControls[a]=b;map.addControl(b)}function initBaseMap(){if(typeof(google)=="undefined"){showGGlMap=false}format="image/jpeg";var a={controls:[new OpenLayers.Control.Navigation(),new OpenLayers.Control.PanZoomBar(),new OpenLayers.Control.DragPan(),new OpenLayers.Control.Attribution()],numZoomLevels:18,projection:"EPSG:4326",allOverlays:true,div:"map",fractionalZoom:false,center:new OpenLayers.LonLat(113.2,25.01),zoom:15};
maxBounds=new OpenLayers.Bounds(70,5,120,60);map=new OpenLayers.Map(a);var d=specifyLayers?specifyLayers.join():null;var c=false;var b=getToolCode(window);vector=new OpenLayers.Layer.Vector("Vector Layer",{isBaseLayer:map.layers.length==0});map.addLayer(vector);drawLayer=new OpenLayers.Layer.Vector("Draw Layer");map.addLayer(drawLayer);map.events.register("move",map,function(h){var f=popup.data("lonlat");if(f){var g=map.getPixelFromLonLat(popup.data("lonlat"));popup.move(g.x,g.y)}});map.events.register("zoomend",map,function(h){var f=popup.data("lonlat");if(f){var g=map.getPixelFromLonLat(popup.data("lonlat"));popup.move(g.x,g.y)}})}function initStyle(){var a={Polygon:{strokeWidth:2,strokeOpacity:1,strokeColor:"#666666",fillColor:"white",fillOpacity:0.3,strokeDashstyle:"dash"}};var b=new OpenLayers.Style();
styleMap=new OpenLayers.StyleMap({"default":b});style_cell={strokeWidth:1,fillColor:"#ff0000",strokeColor:"#660066",fillOpacity:0.7,strokeDashstyle:"dash"};style_cellr={strokeWidth:1,fillColor:"#FFFF11",strokeColor:"#440088",fillOpacity:0.7,strokeDashstyle:"dash"};style_mark=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);style_mark.fillColor="#6CE263";style_mark.fillOpacity=0.7;style_line=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);style_line.strokeWidth=1;style_line.strokeColor="#ee0011";style_line.strokeOpacity=0.8;style_line2=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);style_line2.strokeWidth=1;style_line2.strokeColor="#0055ff";style_line2.strokeOpacity=0.8}function toggleGraticule(){if(!graticule){graticule=new OpenLayers.Control.Graticule({numPoints:1,labelled:true});
map.addControl(graticule)}graticule.visible=!graticule.visible;if(graticule.visible){graticule.deactivate()}else{graticule.activate()}}function initCtrl(){drawControls={pan:new OpenLayers.Control.Pan(),zoomBox:new OpenLayers.Control.ZoomBox(),scanInfo:new OpenLayers.Control.DrawFeature(vector,OpenLayers.Handler.Point,{callbacks:{done:function(b){}}}),cellInfo:new OpenLayers.Control.DrawFeature(vector,OpenLayers.Handler.Click,{callbacks:{click:function(b){var c=map.getLonLatFromLayerPx(new OpenLayers.Pixel(b.x,b.y));queryCellByLonLat(c)},stopSingle:true}}),line:new OpenLayers.Control.DrawFeature(drawLayer,OpenLayers.Handler.Path),polygonMeasure:new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,{persist:true,handlerOptions:{layerOptions:{styleMap:styleMap}}}),distance:new OpenLayers.Control.DistanceMeasure({persist:true,immediate:true,callbacks:{handleDeactivate:function(){$("#mapToolbar img:eq(0)").click()
}}})};drawControls.pan.events.register("activate",null,function(){$("#map").addClass("map_hand")});drawControls.pan.events.register("deactivate",null,function(){$("#map").removeClass("map_hand")});for(var a in drawControls){map.addControl(drawControls[a])}}function initMap(){initBaseMap();initStyle();initCtrl();var a=document.getElementById("mapTypeCtl");var b=document.getElementById("mapToolbar");OpenLayers.Event.observe(a,"mousedown",OpenLayers.Function.bindAsEventListener(OpenLayers.Event.stop));OpenLayers.Event.observe(b,"mousedown",OpenLayers.Function.bindAsEventListener(OpenLayers.Event.stop));OpenLayers.Event.observe(b,"dblclick",OpenLayers.Function.bindAsEventListener(OpenLayers.Event.stop));initSearchDlg();popup=$("#cellInfo").anchored2({title:"小区信息",parentId:"map",show:false});initLayerEditor();
autoCompleteCell()}function toggleControl(a){for(key in drawControls){var b=drawControls[key];if(a==key){b.activate()}else{b.deactivate()}}};